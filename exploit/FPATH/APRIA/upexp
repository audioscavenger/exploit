upexp() {
#@(t)  |UNAME |out|mod|set|sys|net|app|mis| description                                                                                        |
#@(p)  |Linux | x | x |   |   |   | x | x | upload profile to a remote server                                                                  |
local USAGE="${C}${FUNCNAME}${c} [-rdf] <server|all> [[generic*|ihs|was|dmgr|kheops|hkeops] [wasVersion]]
${C}${FUNCNAME}${c} [-rdvtf] <server|all> [/localPathToSingleFile]
<server|all> will upload DIREXPLOIT to remoteServer:remoteDIREXPLOIT=${remoteDIREXPLOIT}"

if [[ "${masters}" == "${masters##*$HOSTNAME}" ]]; then
  ERROR host "upexp ONLY authorized from ${C}${masters}${END}" 0
  echo2 "$USAGE"
  return 99
fi

local removeRemoteContent remoteCSVArch singleFile serverParam serverType wasVersions hostType TMP CR RSYNC_AIX color commandSSH FORCE
local remoteServerList remoteServer serverType wasVersions localFileList remotePath found
FORCE=false
removeRemoteContent=false
remoteUser=${remoteUser:-$LOGNAME}
commandSSH="command ${ssh} -qx -l ${remoteUser} -T"
singleFile=false
hostType=DNS
CR=1
RSYNC_AIX="--rsync-path=${DIREXPLOIT}/bin/AIX/rsync"
TMP=$(mktemp -t ${FUNCNAME}.XXXXXX)

while getopts :rdvtf _OPT 2>/dev/null
do
{
  case ${_OPT} in
    r) removeRemoteContent=true ;;
    d) local Debug=true && local Verbose=true ;;
    v) local Verbose=true ;;
    t) commandSSH="${commandSSH} -o ConnectTimeout=" ;;
    f) FORCE=true ;;
    *) _NOARGS="${_NOARGS}${_NOARGS+, }-${OPTARG}" ;;
  esac
}
done
shift $((OPTIND - 1))
unset _OPT OPTARG OPTIND
[ "X${_NOARGS}" != "X" ] && ERROR param "${_NOARGS}"

serverParam="$1"
serverType=${2:-generic}
wasVersions="${@:3}"
wasVersions="${wasVersions:-0}"
remoteUser=${remoteUser:-root}

if (( $# < 1 )); then
  echo2 "$USAGE"
  [ ! -s "${srvList}" ] && ERROR exist "${srvList}" 0 && return 99
  ${awk} '!/^#/ {FS=";";print $1}' ${srvList}
  return 99
fi

[ ! -s "${srvList}" ] && ERROR exist "${srvList}" 0 && return 1
[ ! -n "${remoteDIREXPLOIT}" ] && ERROR var "remoteDIREXPLOIT" 0 && return 1

if $Debug; then
echo2 serverParam=$serverParam
echo2 serverType=$serverType
echo2 wasVersions=$wasVersions
echo2 remoteUser=$remoteUser
echo2 srvList=${srvList}
fi

[ "${serverParam}" == "all" ] && remoteServerList=$(${awk} '!/^#/ {FS=";";print $1}' ${srvList}) || remoteServerList=${serverParam}
for remoteServer in ${remoteServerList}
do
  if [ "${serverParam}" != "all" ]; then
    [[ ${remoteServer} == [1-9]*\.*\.*\.* ]] && hostType=IP
    if [ "${hostType}" == "DNS" ]; then
      ! $FORCE && host ${remoteServer}.${defaultDomain} >/dev/null 2>&1 | egrep "can't find|not found|SERVFAIL" && ERROR dns ${remoteServer} 0 && return 1
      # new server: adding it to the $srvList
      if ! grep -qi "^${remoteServer};" ${srvList}; then
        ! $FORCE && ! ping -c 1 ${remoteServer} >/dev/null 2>&1 && ERROR ping ${remoteServer} 0 && return 2
        remoteCSVArch=$(grep printf ${DIREXPLOIT}/bin/showCSVArch.sh | ${commandSSH} ${remoteServer} /bin/bash 2>&1)
        ${print} "${remoteServer};${serverType};${wasVersions}${remoteCSVArch:+;}${remoteCSVArch}\n" >>${srvList}
      fi
    fi
  fi
  grep -i "^${remoteServer};" ${srvList} | tr ';' ' ' |\
  while read -r server serverType wasVersions remoteCSVArch; do
    remotePath="${remoteDIREXPLOIT}"
    localFileList="${DIREXPLOIT}/profile.sh ${DIREXPLOIT}/FPATH ${DIREXPLOIT}/bin ${DIREXPLOIT}/lib ${DIREXPLOIT}/etc ${DIREXPLOIT}/share"
    case ${serverType} in
    ihs)      color=${y} ;;
    was)      color=${g} ;;
    dmgr)     color=${Y} ; localFileList="${localFileList} ${DIREXPLOIT}/was";;
    kheops)   color=${gg[1]} ;;
    hkheops)  color=${g12} ;;
    generic)  color=${w} ;;
    *)        [ ! -f "${serverType}" ] && ERROR exist "${remoteServer}: ${serverType}" 0 && CR=3 && return $CR
              localFileList="${serverType}" && remotePath=${remotePath}/${serverType} && singleFile=true ;;
    esac
    
    $removeRemoteContent && ! $singleFile && command ${ssh} -qnx -l ${remoteUser} ${remoteServer} "rm -r ${localFileList} 2>/dev/null" 2>/dev/null && ${print} "%s %-30s : %10s : %10s : %s${END}\n" ${c} ${remoteServer} ${serverType} "${wasVersions}" "remove ${localFileList}:  ${OK}"

    #-------------------------------------------------------------------------------------------------
    ${print} "%s %-30s : %10s : %10s : ${END}" ${color} ${remoteServer} ${serverType} "${wasVersions}"
    if $Verbose; then
      echo2 ${m}"command rsync -Walv -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}"
      if $Debug; then
        command rsync -Walv -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/ 2>&1 | tee ${TMP}
        CR=${PIPESTATUS[0]}
      else
        command rsync -Walv -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/ >${TMP} 2>&1
        CR=$?
      fi
    else
      command rsync -Walv -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/ >${TMP} 2>&1
      CR=$?
    fi
    if [ $CR -eq 12 -o $CR -eq 127 ]; then
      $Verbose && echo2 ${m}"command rsync -Walv ${RSYNC_AIX} -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/"
      command rsync -Walv ${RSYNC_AIX} -e "${ssh}" --progress ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/ >>${TMP} 2>&1
      CR=$?
    fi
    if (( CR != 0 )); then
      # $Debug && cat ${TMP}
      # first time transfer:
      $Verbose && echo "command ${ssh} -qnx -l ${remoteUser} ${remoteServer} \"mkdir -p ${remotePath}\"" | tee -a ${TMP} 
      command ${ssh} -qnx -l ${remoteUser} ${remoteServer} "mkdir -p ${remotePath}" >>${TMP} 2>&1 
      $Verbose && echo2 "command ${scp} -vrp ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/" | tee -a ${TMP} 
      command ${scp} -vrp ${localFileList} ${remoteUser}@${remoteServer}:${remotePath}/ >>${TMP} 2>&1 && CR=0
      command ${ssh} -qnx -l ${remoteUser} ${remoteServer} sync >>${TMP} 2>&1 
      #-------------------------------------------------------------------------------------------------
      (( CR == 0 )) && ${print} "%4s files sent ... ${OK}\n" $(grep 'Sending file timestamps' ${TMP} | wc -l) || (echo ${KO}; echo ${TMP})
    else
      #-------------------------------------------------------------------------------------------------
      (( CR == 0 )) && ${print} "%4s files sent ... ${OK}\n" $(grep 'xfer#' ${TMP} | wc -l) || (echo ${KO}; echo ${TMP})
    fi
    $Debug && cat ${TMP}
    # http://tldp.org/LDP/abs/html/internalvariables.html
    # INFO: (( SHLVL == 2 )) means we're calling this function like this: tty(0) -> screen(1) -> upexp(2)
    # INFO: (( SHLVL == 3 )) means we're calling this function like this: tty(0) -> screen(1) -> upexp_many(2) -> upexp(3)
    (( SHLVL == 2 )) && echoHS "upexp ${remoteServer}: CR=$CR"
    break
  done
done
((CR == 0)) && rm -f ${TMP}
return $CR
}
