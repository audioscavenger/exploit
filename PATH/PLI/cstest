#@(t)  |UNAME |out|mod|set|sys|net|app|mis| description                                                                                        |
#@(p)  |Linux | x | x |   | x |   | x |   | crosdsec explain log pipeline for testing nginx and log lines                                      |

(( $# == 0 )) && (
  echo2 "ERROR : syntax = $0 <logFile|\"logLine\"> [type:*nging|syslog]"
  echo2 "Examples:"
  echo2 "cscli explain --file ./myfile.log --type nginx"
  echo2 "cscli explain --log \'Sep 19 18:33:22 scw-d95986 sshd[24347]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=1.2.3.4\' --type syslog"
  echo2 "cscli explain --dsn file://myfile.log --type nginx"
  echo2 "tail -n 5 myfile.log | cscli explain --type nginx -f -"
) && exit 99

what=log
type=nginx

(( $# == 2 )) && type=$2

if [ -s "$1" -o "${1::1}" = "/" ]; then
  # $1 is a file
  what=file
elif [ "${1%//*}" = "file:" ]; then
  # @1 is dns file://myfile.log
  type=dsn
else
  # $1 is a string
  what=log
fi

shopt -s expand_aliases
if [ "`docker ps --filter "name=crowdsec" -q`" != "" ]; then
  alias cscli='docker exec -t crowdsec cscli'
else
  which cscli >/dev/null
  (($?)) && echo2 "ERROR : cscli command not found" && exit 1
fi
echo2 "cscli explain --${what} '$1' --type ${type} -v"
cscli explain --${what} "$1" --type ${type} -v
