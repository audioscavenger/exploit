(($# == 0)) && echo2 "f2b <me|-ip 1.2.3.4>" && exit 99

unset IP2unban Chains line2unban num2unban

while (($# > 0)); do
  case "x$1" in
    "x--help"|"x-h")  echo2 "f2b <me|ip>" && exit 99 ;;
    "xserver")        IP2unban=$(dig +short txt ch whoami.cloudflare @1.0.0.1) ;;
    "xme")            IP2unban=$(who -m --ips | egrep -o '([0-9]{1,3}\.){3}[0-9]{1,3}') ;;
    "x-ip")           IP2unban=${2} && shift ;;
    *)                echo2 "f2b <me|ip>" && exit 99 ;;
  esac
  shift
done

echo Unbanning $IP2unban...

Chains=$(iptables -L -n | awk '/^Chain / {print $2}')
for Chain in $Chains; do
  echo Chain $Chain:
  # dig will return a double quoted IP, therefore we need to remove the quotes
  line2unban=$(iptables -L $Chain -n --line-numbers | grep "${IP2unban//\"}")
  test -n "${line2unban-}" && echo2 $line2unban && num2unban=${line2unban%% *} && iptables -D $Chain $num2unban
  unset line2unban
done

